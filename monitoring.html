<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- Ù‡Ø¯Ø±Ù‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://unpkg.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://unpkg.com; font-src https://fonts.gstatic.com; img-src 'self' data: https://*.tile.openstreetmap.org; connect-src 'self';">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <title>PBDO | Ù¾Ø§ÛŒØ´ Ø²Ù†Ø¯Ù‡ Ø§Ø³ØªØ§Ù†â€ŒÙ‡Ø§</title>
  <meta name="description" content="Ù¾Ø§ÛŒØ´ Ø²Ù†Ø¯Ù‡ ØªÙ‡Ø¯ÛŒØ¯Ø§Øª Ø²ÛŒØ³ØªÛŒ Ø¯Ø± Û³Û± Ø§Ø³ØªØ§Ù† Ú©Ø´ÙˆØ± â€” Ø³Ø§Ø²Ù…Ø§Ù† Ù¾Ø¯Ø§ÙÙ†Ø¯ Ø²ÛŒØ³ØªÛŒ Ø¹Ù…ÙˆÙ…ÛŒ PBDO"/>
  <link rel="canonical" href="https://pbdo.tech/monitoring.html"/>
  <link rel="icon" type="image/svg+xml" href="logo.svg"/>
  <link rel="manifest" href="manifest.json"/>
  <link rel="stylesheet" href="print.css" media="print"/>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;700;900&display=swap" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    *{font-family:'Vazirmatn',sans-serif;}
    body{background:#0a0a0a;color:#e0e8ff;margin:0;}

    /* ---- neon helpers ---- */
    .neon-green{color:#00ff88;text-shadow:0 0 8px #00ff88,0 0 20px #00ff88;}
    .neon-cyan{color:#00f0ff;text-shadow:0 0 8px #00f0ff,0 0 20px #00f0ff;}
    .neon-border{border:1px solid #00f0ff55;box-shadow:0 0 10px #00f0ff22;}

    /* ---- glassmorphism nav ---- */
    nav.main-nav{
      position:fixed;top:0;width:100%;z-index:200;
      backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);
      background:rgba(10,10,10,.82);
      border-bottom:1px solid rgba(0,240,255,.15);
    }

    /* ---- emergency banner ---- */
    #emergencyBanner{
      display:none;background:linear-gradient(90deg,#ff003c,#ff6600);
      color:#fff;text-align:center;padding:10px 16px;font-weight:700;
      animation:pulse 1.5s infinite;z-index:300;position:fixed;
      top:64px;width:100%;left:0;
    }

    /* ---- ticker ---- */
    .ticker-wrap{background:rgba(255,0,60,.15);border-bottom:1px solid #ff003c44;overflow:hidden;white-space:nowrap;padding:6px 0;}
    .ticker{display:inline-block;animation:ticker 40s linear infinite;}
    @keyframes ticker{0%{transform:translateX(100vw);}100%{transform:translateX(-100%);}}

    /* ---- cards ---- */
    .card{background:#0d0d0d;border:1px solid rgba(0,240,255,.18);border-radius:14px;padding:22px;transition:all .3s;}
    .card:hover{border-color:#00f0ff;box-shadow:0 0 22px rgba(0,240,255,.2);transform:translateY(-3px);}

    /* ---- stat cards ---- */
    .stat-card{background:#111;border:1px solid rgba(0,240,255,.15);border-radius:12px;padding:16px 22px;text-align:center;}

    /* ---- table ---- */
    #provincesTable{width:100%;border-collapse:collapse;}
    #provincesTable thead th{
      background:#111;color:#00f0ff;padding:12px 14px;
      text-align:right;font-weight:700;font-size:.85rem;
      border-bottom:2px solid rgba(0,240,255,.25);cursor:pointer;
      white-space:nowrap;user-select:none;
    }
    #provincesTable thead th:hover{background:#1a1a1a;}
    #provincesTable thead th .sort-icon{opacity:.4;margin-right:4px;font-size:.75rem;}
    #provincesTable thead th.sorted .sort-icon{opacity:1;color:#00ff88;}
    #provincesTable tbody tr{
      border-bottom:1px solid rgba(255,255,255,.06);
      cursor:pointer;transition:background .2s;
    }
    #provincesTable tbody tr:hover{background:rgba(0,240,255,.06);}
    #provincesTable tbody td{padding:11px 14px;font-size:.88rem;vertical-align:middle;}

    /* ---- threat badges ---- */
    .badge{display:inline-flex;align-items:center;gap:5px;padding:3px 12px;border-radius:20px;font-size:.78rem;font-weight:700;}
    .badge-green {background:rgba(0,255,136,.15);color:#00ff88;border:1px solid rgba(0,255,136,.4);}
    .badge-yellow{background:rgba(255,215,0,.15);color:#ffd700;border:1px solid rgba(255,215,0,.4);}
    .badge-orange{background:rgba(255,102,0,.15);color:#ff6600;border:1px solid rgba(255,102,0,.4);}
    .badge-red   {background:rgba(255,0,60,.15);color:#ff003c;border:1px solid rgba(255,0,60,.4);}

    /* ---- status dot ---- */
    .dot{width:10px;height:10px;border-radius:50%;display:inline-block;}
    .dot-green {background:#00ff88;box-shadow:0 0 6px #00ff88;}
    .dot-yellow{background:#ffd700;box-shadow:0 0 6px #ffd700;}
    .dot-orange{background:#ff6600;box-shadow:0 0 6px #ff6600;}
    .dot-red   {background:#ff003c;box-shadow:0 0 6px #ff003c;animation:pulse 1.2s infinite;}

    /* ---- modal ---- */
    #provinceModal{
      display:none;position:fixed;inset:0;
      background:rgba(0,0,0,.85);z-index:500;
      align-items:center;justify-content:center;padding:16px;
    }
    #provinceModal.active{display:flex;}
    .modal-box{
      background:#0d0d0d;border:1px solid rgba(0,240,255,.3);
      border-radius:18px;width:100%;max-width:780px;max-height:90vh;
      overflow-y:auto;padding:28px;position:relative;
      box-shadow:0 0 60px rgba(0,240,255,.15);
    }
    .modal-box::-webkit-scrollbar{width:6px;}
    .modal-box::-webkit-scrollbar-track{background:#111;}
    .modal-box::-webkit-scrollbar-thumb{background:#00f0ff44;border-radius:4px;}

    /* ---- inputs ---- */
    input[type=text],select{
      background:#111;border:1px solid rgba(0,240,255,.3);
      color:#e0e8ff;padding:9px 14px;border-radius:9px;
      font-family:'Vazirmatn',sans-serif;font-size:.88rem;
      outline:none;transition:border-color .2s;
    }
    input[type=text]:focus,select:focus{border-color:#00f0ff;}

    /* ---- canvas charts ---- */
    canvas.chart{border-radius:12px;background:#111;}

    /* ---- animations ---- */
    @keyframes pulse{0%,100%{opacity:1;}50%{opacity:.55;}}
    @keyframes fadeIn{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}
    .fade-in{animation:fadeIn .35s ease forwards;}

    /* ---- scrollbar ---- */
    ::-webkit-scrollbar{width:7px;}
    ::-webkit-scrollbar-track{background:#0a0a0a;}
    ::-webkit-scrollbar-thumb{background:#00f0ff33;border-radius:4px;}

    /* ---- button ---- */
    .btn{padding:8px 20px;border-radius:8px;font-weight:700;cursor:pointer;border:none;transition:all .25s;font-family:'Vazirmatn',sans-serif;font-size:.85rem;}
    .btn-cyan{background:linear-gradient(135deg,#00f0ff,#0088cc);color:#000;}
    .btn-cyan:hover{box-shadow:0 0 18px rgba(0,240,255,.5);}
    .btn-ghost{background:transparent;border:1px solid rgba(0,240,255,.35);color:#00f0ff;}
    .btn-ghost:hover{background:rgba(0,240,255,.08);}
    .btn-danger{background:rgba(255,0,60,.15);border:1px solid rgba(255,0,60,.4);color:#ff003c;}

    /* ---- detail row ---- */
    .detail-row{display:flex;gap:8px;align-items:center;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.06);}
    .detail-label{color:#888;font-size:.82rem;min-width:120px;}
    .detail-value{color:#e0e8ff;font-size:.88rem;font-weight:600;}

    /* ---- filter bar ---- */
    .filter-bar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;}

    /* ---- responsive ---- */
    @media(max-width:768px){
      #provincesTable thead th:nth-child(5),
      #provincesTable tbody td:nth-child(5){display:none;}
      .filter-bar{flex-direction:column;align-items:stretch;}
    }
    @media(max-width:640px){
      #provincesTable thead th:nth-child(3),
      #provincesTable tbody td:nth-child(3){display:none;}
    }
    .site-logo{width:80px;height:auto;filter:invert(1) sepia(1) saturate(5) hue-rotate(100deg);transition:transform .3s ease;vertical-align:middle;}
    .site-logo:hover{transform:scale(1.05);}
    @media(max-width:768px){.site-logo{width:50px;}}
  </style>
</head>
<body class="min-h-screen">

<!-- ========== EMERGENCY BANNER ========== -->
<div id="emergencyBanner" role="alert">
  ğŸš¨ Ù‡Ø´Ø¯Ø§Ø± Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ: ÙˆØ¶Ø¹ÛŒØª Ø¨Ø­Ø±Ø§Ù†ÛŒ Ø¯Ø± Ø§Ø³ØªØ§Ù† â€” ØªÙ…Ø§Ù… ÙˆØ§Ø­Ø¯Ù‡Ø§ Ø¯Ø± Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ¨Ø§Ø´ Ú©Ø§Ù…Ù„
</div>

<!-- ========== MAIN NAV ========== -->
<nav class="main-nav" role="navigation" aria-label="Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ">
  <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
    <a href="index.html" class="text-lg font-black neon-cyan shrink-0 flex items-center gap-2" aria-label="ØµÙØ­Ù‡ Ø®Ø§Ù†Ù‡ PBDO"><img src="logo.png" alt="Ù„ÙˆÚ¯ÙˆÛŒ Ø³Ø§Ø²Ù…Ø§Ù† Ø¯ÙØ§Ø¹ Ø²ÛŒØ³ØªÛŒ Ø¹Ù…ÙˆÙ…ÛŒ" class="site-logo">ğŸ›¡ï¸ PBDO</a>

    <!-- desktop links -->
    <div class="hidden lg:flex items-center gap-5 text-sm font-semibold flex-wrap justify-end">
      <a href="index.html"       class="hover:text-cyan-400 transition">Ø®Ø§Ù†Ù‡</a>
      <a href="monitoring.html"  class="text-green-400 border-b border-green-400 pb-0.5">Ù¾Ø§ÛŒØ´ Ø²Ù†Ø¯Ù‡</a>
      <a href="radar.html"       class="hover:text-cyan-400 transition">Ø±Ø§Ø¯Ø§Ø±</a>
      <a href="report.html"      class="hover:text-cyan-400 transition">Ú¯Ø²Ø§Ø±Ø´ Ù…Ø±Ø¯Ù…ÛŒ</a>
      <a href="about.html"       class="hover:text-cyan-400 transition">Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§</a>
      <a href="contact.html"     class="hover:text-cyan-400 transition">ØªÙ…Ø§Ø³ Ø¨Ø§ Ù…Ø§</a>
      <a href="admin.html"       class="btn btn-cyan text-xs px-4 py-2">ÙˆØ±ÙˆØ¯ Ù…Ø¯ÛŒØ±Ø§Ù†</a>
    </div>

    <!-- date/time -->
    <div id="currentDateTime" class="hidden lg:block text-xs text-gray-400 shrink-0 font-mono ltr text-left" dir="ltr" aria-live="polite"></div>

    <!-- hamburger -->
    <button id="hamburgerBtn" class="lg:hidden p-2 flex flex-col gap-1.5" onclick="toggleMobileMenu()" aria-label="Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…Ù†Ùˆ" aria-expanded="false" aria-controls="mobileNav">
      <span class="w-6 h-0.5 bg-cyan-400 block"></span>
      <span class="w-6 h-0.5 bg-cyan-400 block"></span>
      <span class="w-6 h-0.5 bg-cyan-400 block"></span>
    </button>
  </div>

  <!-- mobile menu -->
  <div id="mobileNav" class="hidden lg:hidden flex-col border-t border-cyan-900/30 bg-black/90 px-4 py-4 gap-3 text-sm font-semibold">
    <a href="index.html"      class="py-2 border-b border-cyan-900/20 hover:text-cyan-400">Ø®Ø§Ù†Ù‡</a>
    <a href="monitoring.html" class="py-2 border-b border-cyan-900/20 text-green-400">Ù¾Ø§ÛŒØ´ Ø²Ù†Ø¯Ù‡</a>
    <a href="radar.html"      class="py-2 border-b border-cyan-900/20 hover:text-cyan-400">Ø±Ø§Ø¯Ø§Ø±</a>
    <a href="report.html"     class="py-2 border-b border-cyan-900/20 hover:text-cyan-400">Ú¯Ø²Ø§Ø±Ø´ Ù…Ø±Ø¯Ù…ÛŒ</a>
    <a href="about.html"      class="py-2 border-b border-cyan-900/20 hover:text-cyan-400">Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§</a>
    <a href="contact.html"    class="py-2 border-b border-cyan-900/20 hover:text-cyan-400">ØªÙ…Ø§Ø³ Ø¨Ø§ Ù…Ø§</a>
    <a href="admin.html"      class="btn btn-cyan mt-2 text-center block">ÙˆØ±ÙˆØ¯ Ù…Ø¯ÛŒØ±Ø§Ù†</a>
    <div id="currentDateTimeMobile" class="text-xs text-gray-500 pt-2 font-mono" dir="ltr"></div>
  </div>
</nav>

<!-- ========== TICKER ========== -->
<div class="ticker-wrap" style="margin-top:57px;" aria-hidden="true">
  <span class="ticker text-sm font-bold px-4" style="color:#e0e8ff;">
    ğŸ“¡ Ø³ÛŒØ³ØªÙ… Ù¾Ø§ÛŒØ´ Ù…Ù„ÛŒ PBDO Ø¢Ù†Ù„Ø§ÛŒÙ† Ùˆ ÙØ¹Ø§Ù„ Ø§Ø³Øª &nbsp;|&nbsp; ğŸŸ¡ Ù‡Ø´Ø¯Ø§Ø± Ø³Ø·Ø­ Û² Ø¯Ø± Ø§Ø³ØªØ§Ù† Ø§ØµÙÙ‡Ø§Ù† &nbsp;|&nbsp; ğŸŸ  ÙˆØ¶Ø¹ÛŒØª Ø§Ø­ØªÛŒØ§Ø· Ø¯Ø± ØªÙ‡Ø±Ø§Ù† Ùˆ Ø®ÙˆØ²Ø³ØªØ§Ù† &nbsp;|&nbsp; ğŸŸ¢ Û²Û¶ Ø§Ø³ØªØ§Ù† Ø¯Ø± ÙˆØ¶Ø¹ÛŒØª Ø¹Ø§Ø¯ÛŒ &nbsp;|&nbsp; ğŸ”¬ Ø±ØµØ¯ Ù…Ø³ØªÙ…Ø± Û²Û´/Û· Ø¯Ø± ØªÙ…Ø§Ù… Ù†Ù‚Ø§Ø· Ú©Ø´ÙˆØ± &nbsp;|&nbsp; ğŸ›¡ï¸ Project Aegis: Ø¹Ù…Ù„ÛŒØ§ØªÛŒ
  </span>
</div>

<!-- ========== MAIN CONTENT ========== -->
<main class="max-w-7xl mx-auto px-4 py-10">

  <!-- ---- PAGE TITLE ---- -->
  <section class="mb-8 text-center" aria-labelledby="pageTitle">
    <div class="inline-flex items-center gap-2 bg-green-900/20 border border-green-500/30 text-green-400 text-xs px-4 py-1.5 rounded-full mb-4">
      <span class="dot dot-green"></span> Ø³ÛŒØ³ØªÙ… Ù¾Ø§ÛŒØ´ Ø²Ù†Ø¯Ù‡ ÙØ¹Ø§Ù„ Ø§Ø³Øª
    </div>
    <h1 id="pageTitle" class="text-3xl md:text-5xl font-black neon-cyan mb-3">Ù¾Ø§ÛŒØ´ Ø²Ù†Ø¯Ù‡ Ø§Ø³ØªØ§Ù†â€ŒÙ‡Ø§</h1>
    <p class="text-gray-400 text-sm md:text-base max-w-2xl mx-auto leading-7">
      Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ø³Ø·Ø­ ØªÙ‡Ø¯ÛŒØ¯Ø§Øª Ø²ÛŒØ³ØªÛŒ Ø¯Ø± ØªÙ…Ø§Ù… Û³Û± Ø§Ø³ØªØ§Ù† Ú©Ø´ÙˆØ±. Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù‡Ø± Û³Û° Ø«Ø§Ù†ÛŒÙ‡ ÛŒÚ©â€ŒØ¨Ø§Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.
    </p>
  </section>

  <!-- ---- SUMMARY STATS ---- -->
  <section class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8" aria-label="Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ">
    <div class="stat-card">
      <div class="text-2xl font-black neon-cyan">Û³Û±</div>
      <div class="text-gray-400 text-xs mt-1">ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ø§Ø³ØªØ§Ù†â€ŒÙ‡Ø§</div>
    </div>
    <div class="stat-card">
      <div class="text-2xl font-black neon-green" id="statActive">â€”</div>
      <div class="text-gray-400 text-xs mt-1">ÙØ¹Ø§Ù„ (Ø³Ø¨Ø²)</div>
    </div>
    <div class="stat-card">
      <div class="text-2xl font-black" style="color:#ffd700;" id="statWarning">â€”</div>
      <div class="text-gray-400 text-xs mt-1">Ù‡Ø´Ø¯Ø§Ø± (Ø²Ø±Ø¯/Ù†Ø§Ø±Ù†Ø¬ÛŒ)</div>
    </div>
    <div class="stat-card">
      <div class="text-2xl font-black" style="color:#ff003c;" id="statCritical">â€”</div>
      <div class="text-gray-400 text-xs mt-1">Ø¨Ø­Ø±Ø§Ù†ÛŒ (Ù‚Ø±Ù…Ø²)</div>
    </div>
  </section>

  <!-- ---- FILTER CONTROLS ---- -->
  <section class="card mb-6" aria-label="ÙÛŒÙ„ØªØ±Ù‡Ø§">
    <div class="filter-bar">
      <div class="flex-1 min-w-[180px]">
        <label for="searchProvince" class="text-xs text-gray-400 mb-1 block">Ø¬Ø³ØªØ¬ÙˆÛŒ Ø§Ø³ØªØ§Ù†</label>
        <input type="text" id="searchProvince" placeholder="Ù†Ø§Ù… Ø§Ø³ØªØ§Ù† ÛŒØ§ Ù…Ø±Ú©Ø²â€¦" oninput="applyFilters()" aria-label="Ø¬Ø³ØªØ¬ÙˆÛŒ Ø§Ø³ØªØ§Ù†"/>
      </div>
      <div class="min-w-[160px]">
        <label for="threatFilter" class="text-xs text-gray-400 mb-1 block">Ø³Ø·Ø­ ØªÙ‡Ø¯ÛŒØ¯</label>
        <select id="threatFilter" onchange="applyFilters()" aria-label="ÙÛŒÙ„ØªØ± Ø³Ø·Ø­ ØªÙ‡Ø¯ÛŒØ¯">
          <option value="all">Ù‡Ù…Ù‡</option>
          <option value="green">ğŸŸ¢ Ø³Ø¨Ø²</option>
          <option value="yellow">ğŸŸ¡ Ø²Ø±Ø¯</option>
          <option value="orange">ğŸŸ  Ù†Ø§Ø±Ù†Ø¬ÛŒ</option>
          <option value="red">ğŸ”´ Ù‚Ø±Ù…Ø²</option>
        </select>
      </div>
      <div class="min-w-[180px]">
        <label for="sortBy" class="text-xs text-gray-400 mb-1 block">Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ</label>
        <select id="sortBy" onchange="applyFilters()" aria-label="Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ">
          <option value="name">Ù†Ø§Ù…</option>
          <option value="threat">Ø³Ø·Ø­ ØªÙ‡Ø¯ÛŒØ¯</option>
          <option value="sensors">ØªØ¹Ø¯Ø§Ø¯ Ø­Ø³Ú¯Ø±</option>
          <option value="lastCheck">Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±Ø±Ø³ÛŒ</option>
        </select>
      </div>
      <div class="flex items-end">
        <button class="btn btn-ghost" onclick="resetFilters()">Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ</button>
      </div>
    </div>
    <div id="filterCount" class="text-xs text-gray-500 mt-3">Ù†Ù…Ø§ÛŒØ´ Û³Û± Ø§Ø² Û³Û± Ø§Ø³ØªØ§Ù†</div>
  </section>

  <!-- ---- PROVINCES TABLE ---- -->
  <section class="card mb-10 overflow-x-auto" aria-label="Ø¬Ø¯ÙˆÙ„ Ù¾Ø§ÛŒØ´ Ø§Ø³ØªØ§Ù†â€ŒÙ‡Ø§">
    <table id="provincesTable" role="grid" aria-label="Ø¬Ø¯ÙˆÙ„ ÙˆØ¶Ø¹ÛŒØª Ø§Ø³ØªØ§Ù†â€ŒÙ‡Ø§">
      <thead>
        <tr>
          <th onclick="sortTable('name')"     data-col="name">     Ø§Ø³ØªØ§Ù†         <span class="sort-icon">â–¼</span></th>
          <th onclick="sortTable('capital')"  data-col="capital">  Ù…Ø±Ú©Ø²          <span class="sort-icon">â–¼</span></th>
          <th onclick="sortTable('threat')"   data-col="threat">   Ø³Ø·Ø­ ØªÙ‡Ø¯ÛŒØ¯     <span class="sort-icon">â–¼</span></th>
          <th onclick="sortTable('sensors')"  data-col="sensors">  Ø­Ø³Ú¯Ø±Ù‡Ø§ÛŒ ÙØ¹Ø§Ù„  <span class="sort-icon">â–¼</span></th>
          <th onclick="sortTable('lastCheck')" data-col="lastCheck">Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±Ø±Ø³ÛŒ  <span class="sort-icon">â–¼</span></th>
          <th>ÙˆØ¶Ø¹ÛŒØª</th>
          <th>Ø¬Ø²Ø¦ÛŒØ§Øª</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <!-- populated by JS -->
      </tbody>
    </table>
  </section>

  <!-- ---- REAL-TIME CHARTS ---- -->
  <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-10" aria-label="Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ÛŒ Ø²Ù†Ø¯Ù‡">
    <div class="card">
      <h2 class="text-sm font-bold text-cyan-400 mb-4">ğŸ“ˆ Ø±ÙˆÙ†Ø¯ Ø³Ø·Ø­ ØªÙ‡Ø¯ÛŒØ¯ â€” Û²Û´ Ø³Ø§Ø¹Øª Ú¯Ø°Ø´ØªÙ‡ (Ø§ÛŒØ±Ø§Ù†)</h2>
      <canvas id="lineChart" class="chart w-full" height="200" aria-label="Ù†Ù…ÙˆØ¯Ø§Ø± Ø®Ø·ÛŒ Ø±ÙˆÙ†Ø¯ ØªÙ‡Ø¯ÛŒØ¯ Û²Û´ Ø³Ø§Ø¹ØªÙ‡"></canvas>
    </div>
    <div class="card">
      <h2 class="text-sm font-bold text-cyan-400 mb-4">ğŸ“Š Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ Ø¨Ù‡ ØªÙÚ©ÛŒÚ© Ø§Ø³ØªØ§Ù† â€” Û±Û° Ø§Ø³ØªØ§Ù† Ø¨Ø±ØªØ±</h2>
      <canvas id="barChart" class="chart w-full" height="200" aria-label="Ù†Ù…ÙˆØ¯Ø§Ø± Ù…ÛŒÙ„Ù‡â€ŒØ§ÛŒ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ Ø¨Ù‡ ØªÙÚ©ÛŒÚ© Ø§Ø³ØªØ§Ù†"></canvas>
    </div>
  </section>

</main>

<!-- ========== PROVINCE DETAIL MODAL ========== -->
<div id="provinceModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" onclick="closeModalOnBackdrop(event)">
  <div class="modal-box fade-in" id="modalBox">
    <button class="absolute top-4 left-4 btn btn-ghost text-xs" onclick="closeModal()" aria-label="Ø¨Ø³ØªÙ†">âœ• Ø¨Ø³ØªÙ†</button>

    <div class="flex items-start gap-4 mb-6">
      <div id="modalThreatBadge"></div>
      <div>
        <h2 id="modalTitle" class="text-xl font-black neon-cyan mb-1"></h2>
        <div class="text-gray-400 text-sm" id="modalCapital"></div>
      </div>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
      <div class="stat-card"><div class="text-lg font-black neon-green" id="modalSensors">â€”</div><div class="text-gray-400 text-xs mt-1">Ø­Ø³Ú¯Ø± ÙØ¹Ø§Ù„</div></div>
      <div class="stat-card"><div class="text-lg font-black neon-cyan" id="modalAlerts">â€”</div><div class="text-gray-400 text-xs mt-1">Ù‡Ø´Ø¯Ø§Ø± Û²Û´ Ø³Ø§Ø¹ØªÙ‡</div></div>
      <div class="stat-card"><div class="text-lg font-black" style="color:#ffd700" id="modalReports">â€”</div><div class="text-gray-400 text-xs mt-1">Ú¯Ø²Ø§Ø±Ø´ Ù…Ø±Ø¯Ù…ÛŒ</div></div>
      <div class="stat-card"><div class="text-sm font-bold text-gray-300" id="modalLastCheck">â€”</div><div class="text-gray-400 text-xs mt-1">Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±Ø±Ø³ÛŒ</div></div>
    </div>

    <!-- cities -->
    <div class="mb-6">
      <h3 class="text-xs font-bold text-gray-400 uppercase mb-3">Ø´Ù‡Ø±Ù‡Ø§ÛŒ ØªØ­Øª Ù¾Ø§ÛŒØ´</h3>
      <div id="modalCities" class="flex flex-wrap gap-2"></div>
    </div>

    <!-- recent alerts -->
    <div class="mb-6">
      <h3 class="text-xs font-bold text-gray-400 uppercase mb-3">Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ÛŒ Ø§Ø®ÛŒØ±</h3>
      <div id="modalAlertsList" class="space-y-2"></div>
    </div>

    <!-- 24h trend mini chart -->
    <div>
      <h3 class="text-xs font-bold text-gray-400 uppercase mb-3">Ø±ÙˆÙ†Ø¯ Û²Û´ Ø³Ø§Ø¹ØªÙ‡ Ø§Ø³ØªØ§Ù†</h3>
      <canvas id="modalChart" class="chart w-full" height="120" aria-label="Ø±ÙˆÙ†Ø¯ Û²Û´ Ø³Ø§Ø¹ØªÙ‡ Ø§Ø³ØªØ§Ù†"></canvas>
    </div>
  </div>
</div>

<!-- ========== FOOTER ========== -->
<footer class="mt-10 border-t border-cyan-900/20 py-12 bg-black/40">
  <div class="max-w-7xl mx-auto px-4">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">

      <!-- org info -->
      <div>
        <div class="text-lg font-black neon-cyan mb-3">ğŸ›¡ï¸ PBDO</div>
        <p class="text-gray-400 text-sm leading-7">
          Ø³Ø§Ø²Ù…Ø§Ù† Ù¾Ø¯Ø§ÙÙ†Ø¯ Ø²ÛŒØ³ØªÛŒ Ø¹Ù…ÙˆÙ…ÛŒ â€” Ù¾ÛŒØ´Ø±Ùˆ Ø¯Ø± Ù¾Ø§ÛŒØ´ ØªÙ‡Ø¯ÛŒØ¯Ø§Øª Ø²ÛŒØ³ØªÛŒØŒ
          Ø§Ù…Ù†ÛŒØª Ø¨ÛŒÙˆÙ„ÙˆÚ˜ÛŒÚ© Ùˆ Ø¯ÙØ§Ø¹ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ±Ø§Ù†
        </p>
        <div class="mt-3 inline-block text-xs bg-green-900/30 border border-green-500/30 text-green-400 px-3 py-1 rounded-full">
          âš¡ Powered by PBDO
        </div>
      </div>

      <!-- quick links -->
      <div>
        <h3 class="text-sm font-bold text-cyan-400 mb-3">Ø¯Ø³ØªØ±Ø³ÛŒ Ø³Ø±ÛŒØ¹</h3>
        <ul class="space-y-2 text-sm text-gray-400">
          <li><a href="index.html"      class="hover:text-cyan-400 transition">Ø®Ø§Ù†Ù‡</a></li>
          <li><a href="monitoring.html" class="hover:text-cyan-400 transition text-green-400">Ù¾Ø§ÛŒØ´ Ø²Ù†Ø¯Ù‡</a></li>
          <li><a href="radar.html"      class="hover:text-cyan-400 transition">Ø±Ø§Ø¯Ø§Ø±</a></li>
          <li><a href="report.html"     class="hover:text-cyan-400 transition">Ú¯Ø²Ø§Ø±Ø´ Ù…Ø±Ø¯Ù…ÛŒ</a></li>
          <li><a href="about.html"      class="hover:text-cyan-400 transition">Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§</a></li>
          <li><a href="contact.html"    class="hover:text-cyan-400 transition">ØªÙ…Ø§Ø³ Ø¨Ø§ Ù…Ø§</a></li>
          <li><a href="admin.html"      class="hover:text-cyan-400 transition">ÙˆØ±ÙˆØ¯ Ù…Ø¯ÛŒØ±Ø§Ù†</a></li>
        </ul>
      </div>

      <!-- contact -->
      <div>
        <h3 class="text-sm font-bold text-cyan-400 mb-3">Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø§Ø³</h3>
        <ul class="space-y-2 text-sm text-gray-400">
          <li>ğŸ“§ admin@pbdo.tech</li>
          <li>ğŸŒ pbdo.tech</li>
          <li>ğŸ“ Ø§ÛŒØ±Ø§Ù†ØŒ ØªÙ‡Ø±Ø§Ù†</li>
          <li class="pt-2 text-xs text-gray-600">Ø³ÛŒØ³ØªÙ… Ù¾Ø§ÛŒØ´ Û²Û´/Û· ÙØ¹Ø§Ù„ Ø§Ø³Øª</li>
        </ul>
      </div>
    </div>

    <div class="border-t border-cyan-900/20 pt-6 text-center text-xs text-gray-600">
      <p>Â© Û±Û´Û°Û´ Ø³Ø§Ø²Ù…Ø§Ù† Ù¾Ø¯Ø§ÙÙ†Ø¯ Ø²ÛŒØ³ØªÛŒ Ø¹Ù…ÙˆÙ…ÛŒ â€” ØªÙ…Ø§Ù… Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸ Ø§Ø³Øª</p>
      <p class="mt-1 text-gray-700">Ø§ÛŒÙ† Ø³Ø§Ù…Ø§Ù†Ù‡ ØªØ­Øª Ù†Ø¸Ø§Ø±Øª Ù…Ø³ØªÙ‚ÛŒÙ… ØªÛŒÙ… Ø§Ù…Ù†ÛŒØª Ø³Ø§ÛŒØ¨Ø±ÛŒ PBDO Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ø¯</p>
    </div>
  </div>
</footer>

<!-- ========== SCRIPTS ========== -->
<script src="scripts.js" defer></script>
<script>
/* ============================================================
   PROVINCE DATA
   ============================================================ */
const PROVINCE_CITIES = {
  'Ø¢Ø°Ø±Ø¨Ø§ÛŒØ¬Ø§Ù† Ø´Ø±Ù‚ÛŒ':   ['ØªØ¨Ø±ÛŒØ²','Ù…Ø±Ø§ØºÙ‡','Ù…Ø±Ù†Ø¯','Ø§Ù‡Ø±','Ø¨Ù†Ø§Ø¨','Ù…ÛŒØ§Ù†Ù‡','Ø³Ø±Ø§Ø¨','Ø´Ø¨Ø³ØªØ±','Ù‡Ø´ØªØ±ÙˆØ¯','Ù…Ù„Ú©Ø§Ù†'],
  'Ø¢Ø°Ø±Ø¨Ø§ÛŒØ¬Ø§Ù† ØºØ±Ø¨ÛŒ':   ['Ø§Ø±ÙˆÙ…ÛŒÙ‡','Ø®ÙˆÛŒ','Ù…Ù‡Ø§Ø¨Ø§Ø¯','Ø¨ÙˆÚ©Ø§Ù†','Ø³Ù„Ù…Ø§Ø³','Ù…ÛŒØ§Ù†Ø¯ÙˆØ¢Ø¨','Ø³Ø±Ø¯Ø´Øª','Ù†Ù‚Ø¯Ù‡','Ù¾ÛŒØ±Ø§Ù†Ø´Ù‡Ø±','Ø§Ø´Ù†ÙˆÛŒÙ‡'],
  'Ø§Ø±Ø¯Ø¨ÛŒÙ„':           ['Ø§Ø±Ø¯Ø¨ÛŒÙ„','Ù¾Ø§Ø±Ø³â€ŒØ¢Ø¨Ø§Ø¯','Ø®Ù„Ø®Ø§Ù„','Ù…Ø´Ú¯ÛŒÙ†â€ŒØ´Ù‡Ø±','Ú¯Ø±Ù…ÛŒ','Ù†Ù…ÛŒÙ†','Ù†ÛŒØ±','Ø³Ø±Ø¹ÛŒÙ†','Ø¨ÛŒÙ„Ù‡â€ŒØ³ÙˆØ§Ø±','Ú©ÙˆØ«Ø±'],
  'Ø§ØµÙÙ‡Ø§Ù†':           ['Ø§ØµÙÙ‡Ø§Ù†','Ú©Ø§Ø´Ø§Ù†','Ø®Ù…ÛŒÙ†ÛŒâ€ŒØ´Ù‡Ø±','Ù†Ø¬Ùâ€ŒØ¢Ø¨Ø§Ø¯','Ø´Ø§Ù‡ÛŒÙ†â€ŒØ´Ù‡Ø±','ÙÙ„Ø§ÙˆØ±Ø¬Ø§Ù†','Ø´Ù‡Ø±Ø¶Ø§','Ø§Ø±Ø¯Ø³ØªØ§Ù†','Ù†Ø§Ø¦ÛŒÙ†','ØªÛŒØ±Ø§Ù†'],
  'Ø§Ù„Ø¨Ø±Ø²':            ['Ú©Ø±Ø¬','Ú©Ù…Ø§Ù„â€ŒØ´Ù‡Ø±','Ù†Ø¸Ø±Ø¢Ø¨Ø§Ø¯','Ø³Ø§ÙˆØ¬Ø¨Ù„Ø§Øº','Ø·Ø§Ù„Ù‚Ø§Ù†','Ø§Ø´ØªÙ‡Ø§Ø±Ø¯','Ù‡Ø´ØªÚ¯Ø±Ø¯','Ú†Ù‡Ø§Ø±Ø¨Ø§Øº','ÙØ±Ø¯ÛŒØ³','Ú¯Ø±Ù…Ø¯Ø±Ù‡'],
  'Ø§ÛŒÙ„Ø§Ù…':            ['Ø§ÛŒÙ„Ø§Ù…','Ø¯Ù‡Ù„Ø±Ø§Ù†','Ù…Ù‡Ø±Ø§Ù†','Ø§ÛŒÙˆØ§Ù†','Ø¢Ø¨Ø¯Ø§Ù†Ø§Ù†','Ø¯Ø±Ù‡â€ŒØ´Ù‡Ø±','Ø¨Ø¯Ø±Ù‡','Ú†ÙˆØ§Ø±','Ù…Ù„Ú©Ø´Ø§Ù‡ÛŒ','Ø³ÛŒØ±ÙˆØ§Ù†'],
  'Ø¨ÙˆØ´Ù‡Ø±':            ['Ø¨ÙˆØ´Ù‡Ø±','Ø¨Ø±Ø§Ø²Ø¬Ø§Ù†','Ø¨Ù†Ø¯Ø±Ø¯ÛŒÙ„Ù…','Ø®ÙˆØ±Ù…ÙˆØ¬','Ú©Ù†Ú¯Ø§Ù†','Ø¹Ø³Ù„ÙˆÛŒÙ‡','Ø¬Ù…','Ø¯Ø´ØªØ³ØªØ§Ù†','ØªÙ†Ú¯Ø³ØªØ§Ù†','Ø¯Ø´ØªÛŒ'],
  'ØªÙ‡Ø±Ø§Ù†':            ['ØªÙ‡Ø±Ø§Ù†','Ø´Ù‡Ø±ÛŒØ§Ø±','Ø±ÛŒ','Ø§Ø³Ù„Ø§Ù…Ø´Ù‡Ø±','ÙˆØ±Ø§Ù…ÛŒÙ†','Ù¾Ø§Ú©Ø¯Ø´Øª','Ø¯Ù…Ø§ÙˆÙ†Ø¯','ÙÛŒØ±ÙˆØ²Ú©ÙˆÙ‡','Ø¨Ù‡Ø§Ø±Ø³ØªØ§Ù†','Ù…Ù„Ø§Ø±Ø¯'],
  'Ú†Ù‡Ø§Ø±Ù…Ø­Ø§Ù„ Ùˆ Ø¨Ø®ØªÛŒØ§Ø±ÛŒ':['Ø´Ù‡Ø±Ú©Ø±Ø¯','Ø¨Ø±ÙˆØ¬Ù†','ÙØ§Ø±Ø³Ø§Ù†','Ù„Ø±Ø¯Ú¯Ø§Ù†','Ø§Ø±Ø¯Ù„','Ú©ÛŒØ§Ø±','Ú©ÙˆÙ‡Ø±Ù†Ú¯','Ø³Ø§Ù…Ø§Ù†','Ø¨Ù†','Ù‡ÙØ´Ø¬Ø§Ù†'],
  'Ø®Ø±Ø§Ø³Ø§Ù† Ø¬Ù†ÙˆØ¨ÛŒ':     ['Ø¨ÛŒØ±Ø¬Ù†Ø¯','Ù‚Ø§ÛŒÙ†Ø§Øª','ÙØ±Ø¯ÙˆØ³','Ø¨Ø´Ø±ÙˆÛŒÙ‡','Ù†Ù‡Ø¨Ù†Ø¯Ø§Ù†','Ø³Ø±Ø¨ÛŒØ´Ù‡','Ø¯Ø±Ù…ÛŒØ§Ù†','Ø²ÛŒØ±Ú©ÙˆÙ‡','Ø®ÙˆØ³Ù','Ø·Ø¨Ø³'],
  'Ø®Ø±Ø§Ø³Ø§Ù† Ø±Ø¶ÙˆÛŒ':      ['Ù…Ø´Ù‡Ø¯','Ù†ÛŒØ´Ø§Ø¨ÙˆØ±','Ø³Ø¨Ø²ÙˆØ§Ø±','ØªØ±Ø¨Øªâ€ŒØ­ÛŒØ¯Ø±ÛŒÙ‡','Ú©Ø§Ø´Ù…Ø±','Ù‚ÙˆÚ†Ø§Ù†','ØªØ±Ø¨Øªâ€ŒØ¬Ø§Ù…','ÙØ±ÛŒÙ…Ø§Ù†','Ú¯Ù†Ø§Ø¨Ø§Ø¯','Ú†Ù†Ø§Ø±Ø§Ù†'],
  'Ø®Ø±Ø§Ø³Ø§Ù† Ø´Ù…Ø§Ù„ÛŒ':     ['Ø¨Ø¬Ù†ÙˆØ±Ø¯','Ø´ÛŒØ±ÙˆØ§Ù†','Ø§Ø³ÙØ±Ø§ÛŒÙ†','Ø¬Ø§Ø¬Ø±Ù…','Ø¢Ø´Ø®Ø§Ù†Ù‡','ÙØ§Ø±ÙˆØ¬','Ù…Ø§Ù†Ù‡ Ùˆ Ø³Ù…Ù„Ù‚Ø§Ù†','Ú¯Ø±Ù…Ù‡','Ø±Ø§Ø²','ØµÙÛŒâ€ŒØ¢Ø¨Ø§Ø¯'],
  'Ø®ÙˆØ²Ø³ØªØ§Ù†':          ['Ø§Ù‡ÙˆØ§Ø²','Ù…Ø³Ø¬Ø¯Ø³Ù„ÛŒÙ…Ø§Ù†','Ø¢Ø¨Ø§Ø¯Ø§Ù†','Ø®Ø±Ù…Ø´Ù‡Ø±','Ø¯Ø²ÙÙˆÙ„','Ø´ÙˆØ´ØªØ±','Ø§Ù†Ø¯ÛŒÙ…Ø´Ú©','Ø¨Ù‡Ø¨Ù‡Ø§Ù†','Ù…Ø§Ù‡Ø´Ù‡Ø±','Ø¢ØºØ§Ø¬Ø§Ø±ÛŒ'],
  'Ø²Ù†Ø¬Ø§Ù†':            ['Ø²Ù†Ø¬Ø§Ù†','Ø§Ø¨Ù‡Ø±','Ø®Ø±Ù…Ø¯Ø±Ù‡','Ù‚ÛŒØ¯Ø§Ø±','Ø³Ù„Ø·Ø§Ù†ÛŒÙ‡','Ø§ÛŒØ¬Ø±ÙˆØ¯','Ø·Ø§Ø±Ù…','Ù…Ø§Ù‡Ù†Ø´Ø§Ù†','Ø®Ø¯Ø§Ø¨Ù†Ø¯Ù‡','Ø³Ø¬Ø§Ø³Ø±ÙˆØ¯'],
  'Ø³Ù…Ù†Ø§Ù†':            ['Ø³Ù…Ù†Ø§Ù†','Ø´Ø§Ù‡Ø±ÙˆØ¯','Ø¯Ø§Ù…ØºØ§Ù†','Ú¯Ø±Ù…Ø³Ø§Ø±','Ù…Ù‡Ø¯ÛŒâ€ŒØ´Ù‡Ø±','Ø¢Ø±Ø§Ø¯Ø§Ù†','Ù…ÛŒØ§Ù…ÛŒ','Ø´Ù…ÛŒØ±Ø§Ù†Ø§Øª','Ø³Ø±Ø®Ù‡','Ø¨Ø³Ø·Ø§Ù…'],
  'Ø³ÛŒØ³ØªØ§Ù† Ùˆ Ø¨Ù„ÙˆÚ†Ø³ØªØ§Ù†':['Ø²Ø§Ù‡Ø¯Ø§Ù†','Ø²Ø§Ø¨Ù„','Ø§ÛŒØ±Ø§Ù†Ø´Ù‡Ø±','Ú†Ø§Ø¨Ù‡Ø§Ø±','Ø³Ø±Ø§ÙˆØ§Ù†','Ù†ÛŒÚ©Ø´Ù‡Ø±','Ø®Ø§Ø´','Ø¯Ù„Ú¯Ø§Ù†','Ú©Ù†Ø§Ø±Ú©','Ù‡Ø§Ù…ÙˆÙ†'],
  'ÙØ§Ø±Ø³':             ['Ø´ÛŒØ±Ø§Ø²','Ù…Ø±ÙˆØ¯Ø´Øª','Ø¬Ù‡Ø±Ù…','ÙØ³Ø§','Ú©Ø§Ø²Ø±ÙˆÙ†','Ø¢Ø¨Ø§Ø¯Ù‡','Ù„Ø§Ø±Ø³ØªØ§Ù†','Ù„Ø§Ù…Ø±Ø¯','Ù†ÛŒØ±ÛŒØ²','Ø§Ù‚Ù„ÛŒØ¯'],
  'Ù‚Ø²ÙˆÛŒÙ†':            ['Ù‚Ø²ÙˆÛŒÙ†','Ø¨ÙˆØ¦ÛŒÙ†â€ŒØ²Ù‡Ø±Ø§','ØªØ§Ú©Ø³ØªØ§Ù†','Ø¢Ø¨ÛŒÚ©','Ø§Ù„Ø¨Ø±Ø²','Ø¢ÙˆØ¬','Ù…Ø­Ù…Ø¯ÛŒÙ‡','Ø§Ù‚Ø¨Ø§Ù„ÛŒÙ‡','Ú©ÙˆÙ‡ÛŒÙ†','Ø±Ø§Ù…Ù†Ø¯'],
  'Ù‚Ù…':               ['Ù‚Ù…','Ø¬Ø¹ÙØ±ÛŒÙ‡','Ù‚Ù†ÙˆØ§Øª','Ú©Ù‡Ú©','Ø³Ù„ÙÚ†Ú¯Ø§Ù†','Ø¯Ø³ØªØ¬Ø±Ø¯','Ø®Ù„Ø¬Ø³ØªØ§Ù†','Ù…Ø§Ø±Ú©Ø¯Ù‡','Ø¬Ø¹ÙØ±ÛŒÙ‡','Ù†Ø®Ù„'],
  'Ú©Ø±Ø¯Ø³ØªØ§Ù†':          ['Ø³Ù†Ù†Ø¯Ø¬','Ø³Ù‚Ø²','Ù…Ø±ÛŒÙˆØ§Ù†','Ø¨Ø§Ù†Ù‡','Ù‚Ø±ÙˆÙ‡','Ø¨ÛŒØ¬Ø§Ø±','Ú©Ø§Ù…ÛŒØ§Ø±Ø§Ù†','Ø¯ÛŒÙˆØ§Ù†Ø¯Ø±Ù‡','Ø³Ø±ÙˆØ¢Ø¨Ø§Ø¯','Ø¯Ù‡Ú¯Ù„Ø§Ù†'],
  'Ú©Ø±Ù…Ø§Ù†':            ['Ú©Ø±Ù…Ø§Ù†','Ø³ÛŒØ±Ø¬Ø§Ù†','Ø±ÙØ³Ù†Ø¬Ø§Ù†','Ø¨Ù…','Ø¬ÛŒØ±ÙØª','Ø²Ø±Ù†Ø¯','Ø¨Ø§ÙØª','Ú©Ù‡Ù†ÙˆØ¬','Ø§Ù†Ø§Ø±','Ø´Ù‡Ø±Ø¨Ø§Ø¨Ú©'],
  'Ú©Ø±Ù…Ø§Ù†Ø´Ø§Ù‡':         ['Ú©Ø±Ù…Ø§Ù†Ø´Ø§Ù‡','Ø§Ø³Ù„Ø§Ù…â€ŒØ¢Ø¨Ø§Ø¯ ØºØ±Ø¨','Ø³Ù†Ù‚Ø±','Ù‡Ø±Ø³ÛŒÙ†','ØµØ­Ù†Ù‡','Ú©Ù†Ú¯Ø§ÙˆØ±','Ù¾Ø§ÙˆÙ‡','Ú¯ÛŒÙ„Ø§Ù†ØºØ±Ø¨','Ø«Ù„Ø§Ø«â€ŒØ¨Ø§Ø¨Ø§Ø¬Ø§Ù†ÛŒ','Ø±ÙˆØ§Ù†Ø³Ø±'],
  'Ú©Ù‡Ú¯ÛŒÙ„ÙˆÛŒÙ‡ Ùˆ Ø¨ÙˆÛŒØ±Ø§Ø­Ù…Ø¯':['ÛŒØ§Ø³ÙˆØ¬','Ø¯ÙˆÚ¯Ù†Ø¨Ø¯Ø§Ù†','Ø¯Ù‡Ø¯Ø´Øª','Ø³ÛŒâ€ŒØ³Ø®Øª','Ù¾Ø§ØªØ§ÙˆÙ‡','Ø¨Ø§Ø´Øª','Ú©Ù‡Ú¯ÛŒÙ„ÙˆÛŒÙ‡','Ú†Ø±Ø§Ù…','Ø¨ÙˆÛŒØ±Ø§Ø­Ù…Ø¯','Ù…Ø§Ø±Ú¯ÙˆÙ†'],
  'Ú¯Ù„Ø³ØªØ§Ù†':           ['Ú¯Ø±Ú¯Ø§Ù†','Ú¯Ù†Ø¨Ø¯Ú©Ø§ÙˆÙˆØ³','Ú¯Ø±Ú¯Ø§Ù†','Ø¢Ù‚â€ŒÙ‚Ù„Ø§','Ø¨Ù†Ø¯Ø±Ú¯Ø²','Ø¹Ù„ÛŒâ€ŒØ¢Ø¨Ø§Ø¯ Ú©ØªÙˆÙ„','Ù…ÛŒÙ†ÙˆØ¯Ø´Øª','Ø±Ø§Ù…ÛŒØ§Ù†','Ø¢Ø²Ø§Ø¯Ø´Ù‡Ø±','Ú©Ù„Ø§Ù„Ù‡'],
  'Ú¯ÛŒÙ„Ø§Ù†':            ['Ø±Ø´Øª','Ø§Ù†Ø²Ù„ÛŒ','Ù„Ø§Ù‡ÛŒØ¬Ø§Ù†','Ù„Ù†Ú¯Ø±ÙˆØ¯','Ø¢Ø³ØªØ§Ø±Ø§','Ø±ÙˆØ¯Ø¨Ø§Ø±','ØµÙˆÙ…Ø¹Ù‡â€ŒØ³Ø±Ø§','ÙÙˆÙ…Ù†','Ø·ÙˆØ§Ù„Ø´','Ø´ÙØª'],
  'Ù„Ø±Ø³ØªØ§Ù†':           ['Ø®Ø±Ù…â€ŒØ¢Ø¨Ø§Ø¯','Ø¨Ø±ÙˆØ¬Ø±Ø¯','Ú©ÙˆÙ‡Ø¯Ø´Øª','Ø¯ÙˆØ±ÙˆØ¯','Ø§Ù„ÛŒÚ¯ÙˆØ¯Ø±Ø²','Ø§Ø²Ù†Ø§','Ù¾Ù„Ø¯Ø®ØªØ±','Ù†ÙˆØ±Ø¢Ø¨Ø§Ø¯','Ø³Ù„Ø³Ù„Ù‡','Ø±ÙˆÙ…Ø´Ú©Ø§Ù†'],
  'Ù…Ø§Ø²Ù†Ø¯Ø±Ø§Ù†':         ['Ø³Ø§Ø±ÛŒ','Ø¨Ø§Ø¨Ù„','Ø¢Ù…Ù„','Ù‚Ø§Ø¦Ù…â€ŒØ´Ù‡Ø±','Ù†ÙˆØ´Ù‡Ø±','Ú†Ø§Ù„ÙˆØ³','Ø¨Ø§Ø¨Ù„Ø³Ø±','ØªÙ†Ú©Ø§Ø¨Ù†','Ù…Ø­Ù…ÙˆØ¯Ø¢Ø¨Ø§Ø¯','Ù†Ú©Ø§'],
  'Ù…Ø±Ú©Ø²ÛŒ':            ['Ø§Ø±Ø§Ú©','Ø³Ø§ÙˆÙ‡','Ø®Ù…ÛŒÙ†','Ù…Ø­Ù„Ø§Øª','Ø¯Ù„ÛŒØ¬Ø§Ù†','ØªÙØ±Ø´','Ú©Ù…ÛŒØ¬Ø§Ù†','Ø´Ø§Ø²Ù†Ø¯','Ø¢Ø´ØªÛŒØ§Ù†','Ø²Ø±Ù†Ø¯ÛŒÙ‡'],
  'Ù‡Ø±Ù…Ø²Ú¯Ø§Ù†':          ['Ø¨Ù†Ø¯Ø±Ø¹Ø¨Ø§Ø³','Ø¨Ù†Ø¯Ø± Ù„Ù†Ú¯Ù‡','Ù…ÛŒÙ†Ø§Ø¨','Ù‚Ø´Ù…','Ø­Ø§Ø¬ÛŒâ€ŒØ¢Ø¨Ø§Ø¯','Ø±ÙˆØ¯Ø§Ù†','Ø§Ø¨ÙˆÙ…ÙˆØ³ÛŒ','Ú©ÛŒØ´','Ø¨Ù†Ø¯Ø±Ø¬Ø§Ø³Ú©','Ù¾Ø§Ø±Ø³ÛŒØ§Ù†'],
  'Ù‡Ù…Ø¯Ø§Ù†':            ['Ù‡Ù…Ø¯Ø§Ù†','Ù…Ù„Ø§ÛŒØ±','Ù†Ù‡Ø§ÙˆÙ†Ø¯','ØªÙˆÛŒØ³Ø±Ú©Ø§Ù†','Ø§Ø³Ø¯Ø¢Ø¨Ø§Ø¯','Ø¨Ù‡Ø§Ø±','Ø±Ø²Ù†','Ú©Ø¨ÙˆØ¯Ø±Ø§Ù‡Ù†Ú¯','ÙØ§Ù…Ù†ÛŒÙ†','Ø³Ø§Ù…Ù†'],
  'ÛŒØ²Ø¯':              ['ÛŒØ²Ø¯','Ù…ÛŒØ¨Ø¯','Ø§Ø±Ø¯Ú©Ø§Ù†','Ø§Ø¨Ø±Ú©ÙˆÙ‡','ØªÙØª','Ø¨Ø§ÙÙ‚','Ù…Ù‡Ø±ÛŒØ²','ØµØ¯ÙˆÙ‚','Ø®Ø§ØªÙ…','Ø²Ø§Ø±Ú†']
};

const RAW_PROVINCES = [
  {name:'Ø¢Ø°Ø±Ø¨Ø§ÛŒØ¬Ø§Ù† Ø´Ø±Ù‚ÛŒ',  capital:'ØªØ¨Ø±ÛŒØ²',        threat:'green',  sensors:42},
  {name:'Ø¢Ø°Ø±Ø¨Ø§ÛŒØ¬Ø§Ù† ØºØ±Ø¨ÛŒ',  capital:'Ø§Ø±ÙˆÙ…ÛŒÙ‡',        threat:'green',  sensors:38},
  {name:'Ø§Ø±Ø¯Ø¨ÛŒÙ„',          capital:'Ø§Ø±Ø¯Ø¨ÛŒÙ„',        threat:'green',  sensors:29},
  {name:'Ø§ØµÙÙ‡Ø§Ù†',          capital:'Ø§ØµÙÙ‡Ø§Ù†',        threat:'yellow', sensors:55},
  {name:'Ø§Ù„Ø¨Ø±Ø²',           capital:'Ú©Ø±Ø¬',           threat:'yellow', sensors:48},
  {name:'Ø§ÛŒÙ„Ø§Ù…',           capital:'Ø§ÛŒÙ„Ø§Ù…',          threat:'green',  sensors:22},
  {name:'Ø¨ÙˆØ´Ù‡Ø±',           capital:'Ø¨ÙˆØ´Ù‡Ø±',          threat:'green',  sensors:27},
  {name:'ØªÙ‡Ø±Ø§Ù†',           capital:'ØªÙ‡Ø±Ø§Ù†',          threat:'orange', sensors:80},
  {name:'Ú†Ù‡Ø§Ø±Ù…Ø­Ø§Ù„ Ùˆ Ø¨Ø®ØªÛŒØ§Ø±ÛŒ', capital:'Ø´Ù‡Ø±Ú©Ø±Ø¯',     threat:'green',  sensors:19},
  {name:'Ø®Ø±Ø§Ø³Ø§Ù† Ø¬Ù†ÙˆØ¨ÛŒ',   capital:'Ø¨ÛŒØ±Ø¬Ù†Ø¯',        threat:'green',  sensors:24},
  {name:'Ø®Ø±Ø§Ø³Ø§Ù† Ø±Ø¶ÙˆÛŒ',    capital:'Ù…Ø´Ù‡Ø¯',          threat:'yellow', sensors:60},
  {name:'Ø®Ø±Ø§Ø³Ø§Ù† Ø´Ù…Ø§Ù„ÛŒ',   capital:'Ø¨Ø¬Ù†ÙˆØ±Ø¯',        threat:'green',  sensors:21},
  {name:'Ø®ÙˆØ²Ø³ØªØ§Ù†',         capital:'Ø§Ù‡ÙˆØ§Ø²',          threat:'orange', sensors:65},
  {name:'Ø²Ù†Ø¬Ø§Ù†',           capital:'Ø²Ù†Ø¬Ø§Ù†',          threat:'green',  sensors:25},
  {name:'Ø³Ù…Ù†Ø§Ù†',           capital:'Ø³Ù…Ù†Ø§Ù†',          threat:'green',  sensors:20},
  {name:'Ø³ÛŒØ³ØªØ§Ù† Ùˆ Ø¨Ù„ÙˆÚ†Ø³ØªØ§Ù†', capital:'Ø²Ø§Ù‡Ø¯Ø§Ù†',      threat:'yellow', sensors:35},
  {name:'ÙØ§Ø±Ø³',            capital:'Ø´ÛŒØ±Ø§Ø²',          threat:'green',  sensors:50},
  {name:'Ù‚Ø²ÙˆÛŒÙ†',           capital:'Ù‚Ø²ÙˆÛŒÙ†',          threat:'green',  sensors:30},
  {name:'Ù‚Ù…',              capital:'Ù‚Ù…',             threat:'yellow', sensors:33},
  {name:'Ú©Ø±Ø¯Ø³ØªØ§Ù†',         capital:'Ø³Ù†Ù†Ø¯Ø¬',          threat:'green',  sensors:28},
  {name:'Ú©Ø±Ù…Ø§Ù†',           capital:'Ú©Ø±Ù…Ø§Ù†',          threat:'green',  sensors:37},
  {name:'Ú©Ø±Ù…Ø§Ù†Ø´Ø§Ù‡',        capital:'Ú©Ø±Ù…Ø§Ù†Ø´Ø§Ù‡',       threat:'green',  sensors:32},
  {name:'Ú©Ù‡Ú¯ÛŒÙ„ÙˆÛŒÙ‡ Ùˆ Ø¨ÙˆÛŒØ±Ø§Ø­Ù…Ø¯', capital:'ÛŒØ§Ø³ÙˆØ¬',     threat:'green',  sensors:17},
  {name:'Ú¯Ù„Ø³ØªØ§Ù†',          capital:'Ú¯Ø±Ú¯Ø§Ù†',          threat:'green',  sensors:26},
  {name:'Ú¯ÛŒÙ„Ø§Ù†',           capital:'Ø±Ø´Øª',            threat:'green',  sensors:40},
  {name:'Ù„Ø±Ø³ØªØ§Ù†',          capital:'Ø®Ø±Ù…â€ŒØ¢Ø¨Ø§Ø¯',       threat:'green',  sensors:23},
  {name:'Ù…Ø§Ø²Ù†Ø¯Ø±Ø§Ù†',        capital:'Ø³Ø§Ø±ÛŒ',           threat:'yellow', sensors:52},
  {name:'Ù…Ø±Ú©Ø²ÛŒ',           capital:'Ø§Ø±Ø§Ú©',           threat:'green',  sensors:31},
  {name:'Ù‡Ø±Ù…Ø²Ú¯Ø§Ù†',         capital:'Ø¨Ù†Ø¯Ø±Ø¹Ø¨Ø§Ø³',       threat:'green',  sensors:36},
  {name:'Ù‡Ù…Ø¯Ø§Ù†',           capital:'Ù‡Ù…Ø¯Ø§Ù†',          threat:'green',  sensors:29},
  {name:'ÛŒØ²Ø¯',             capital:'ÛŒØ²Ø¯',            threat:'green',  sensors:22}
];

/* ============================================================
   UTILITY HELPERS
   ============================================================ */

/** Sanitize HTML to prevent XSS */
function sanitizeHTML(str) {
  const div = document.createElement('div');
  div.appendChild(document.createTextNode(String(str)));
  return div.innerHTML;
}

/** Convert Gregorian to Jalali */
function toJalali(gy, gm, gd) {
  const g_d_no = [0,31,59,90,120,151,181,212,243,273,304,334];
  let jy, jm, jd, j_d_no, i, gy2;
  gy2 = (gm > 2) ? gy + 1 : gy;
  let g_d_no2 = 365 * gy + Math.floor((gy2 + 3) / 4) - Math.floor((gy2 + 99) / 100) + Math.floor((gy2 + 399) / 400);
  for (i = 0; i < gm - 1; i++) g_d_no2 += g_d_no[i];
  g_d_no2 += gd - 1;
  j_d_no = g_d_no2 - 79;
  const j_np = Math.floor(j_d_no / 12053);
  j_d_no %= 12053;
  jy = 979 + 33 * j_np + 4 * Math.floor(j_d_no / 1461);
  j_d_no %= 1461;
  if (j_d_no >= 366) { jy += Math.floor((j_d_no - 1) / 365); j_d_no = (j_d_no - 1) % 365; }
  const j_d = [0,31,31,31,31,31,31,30,30,30,30,30,29];
  for (i = 0; i < 12; i++) { if (j_d_no >= j_d[i]) { j_d_no -= j_d[i]; } else { jm = i; jd = j_d_no + 1; break; } }
  if (jm === undefined) { jm = 11; jd = j_d_no + 1; } // edge-case fallback
  return {y: jy, m: jm + 1, d: jd};
}

function jalaliNow() {
  const now = new Date();
  const j = toJalali(now.getFullYear(), now.getMonth() + 1, now.getDate());
  const months = ['ÙØ±ÙˆØ±Ø¯ÛŒÙ†','Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª','Ø®Ø±Ø¯Ø§Ø¯','ØªÛŒØ±','Ù…Ø±Ø¯Ø§Ø¯','Ø´Ù‡Ø±ÛŒÙˆØ±','Ù…Ù‡Ø±','Ø¢Ø¨Ø§Ù†','Ø¢Ø°Ø±','Ø¯ÛŒ','Ø¨Ù‡Ù…Ù†','Ø§Ø³ÙÙ†Ø¯'];
  const hh = String(now.getHours()).padStart(2,'0');
  const mm = String(now.getMinutes()).padStart(2,'0');
  const ss = String(now.getSeconds()).padStart(2,'0');
  return `${j.d} ${months[j.m-1]} ${j.y}  |  ${hh}:${mm}:${ss}`;
}

function toPersianNum(n) {
  return String(n).replace(/\d/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'[d]);
}

/* ============================================================
   PROVINCE STATE
   ============================================================ */
let provinces = [];
let sortCol = 'name';
let sortDir = 1; // 1=asc, -1=desc

const THREAT_ORDER = {green:0, yellow:1, orange:2, red:3};
const THREAT_LABEL = {green:'Ø³Ø¨Ø²', yellow:'Ø²Ø±Ø¯', orange:'Ù†Ø§Ø±Ù†Ø¬ÛŒ', red:'Ù‚Ø±Ù…Ø²'};
const THREAT_EMOJI = {green:'ğŸŸ¢', yellow:'ğŸŸ¡', orange:'ğŸŸ ', red:'ğŸ”´'};

function loadProvinces() {
  const stored = localStorage.getItem('pbdo_provinces');
  if (stored) {
    try {
      const parsed = JSON.parse(stored);
      // merge stored overrides into base data
      provinces = RAW_PROVINCES.map(p => {
        const override = parsed.find(s => s.name === p.name);
        return override ? {...p, ...override} : {...p};
      });
      return;
    } catch(e) { /* fall through */ }
  }
  provinces = RAW_PROVINCES.map(p => ({...p}));
}

function enrichProvinces() {
  const now = Date.now();
  provinces.forEach((p, i) => {
    if (!p.lastCheck) p.lastCheck = new Date(now - (i * 73 + 12) * 60000);
    if (!p.alertCount) p.alertCount = THREAT_ORDER[p.threat] * 3 + Math.floor(Math.random()*4);
    if (!p.reportCount) p.reportCount = Math.floor(Math.random()*20) + 5;
  });
}

/* ============================================================
   RENDER TABLE
   ============================================================ */
function renderTable(list) {
  const tbody = document.getElementById('tableBody');
  if (!list.length) {
    tbody.innerHTML = `<tr><td colspan="7" class="text-center text-gray-500 py-10">Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</td></tr>`;
    return;
  }
  // Use data-idx (numeric index into provinces[]) so no user-controlled text enters event handlers
  tbody.innerHTML = list.map(p => {
    const lc = new Date(p.lastCheck);
    const minAgo = Math.floor((Date.now() - lc.getTime()) / 60000);
    const timeStr = minAgo < 60 ? `${toPersianNum(minAgo)} Ø¯Ù‚ÛŒÙ‚Ù‡ Ù¾ÛŒØ´` : `${toPersianNum(Math.floor(minAgo/60))} Ø³Ø§Ø¹Øª Ù¾ÛŒØ´`;
    const online = minAgo < 30;
    const idx = provinces.indexOf(p);
    return `<tr class="province-row" data-idx="${idx}" tabindex="0" role="row">
      <td class="font-semibold">${sanitizeHTML(p.name)}</td>
      <td class="text-gray-400">${sanitizeHTML(p.capital)}</td>
      <td><span class="badge badge-${p.threat}">${THREAT_EMOJI[p.threat]} ${THREAT_LABEL[p.threat]}</span></td>
      <td class="font-mono neon-green text-sm">${toPersianNum(p.sensors)}</td>
      <td class="text-gray-400 text-xs">${timeStr}</td>
      <td><span class="flex items-center gap-2"><span class="dot dot-${online ? p.threat : 'gray'}"></span><span class="text-xs text-gray-400">${online ? 'Ø¢Ù†Ù„Ø§ÛŒÙ†' : 'Ø¢ÙÙ„Ø§ÛŒÙ†'}</span></span></td>
      <td><button class="btn btn-ghost text-xs px-3 py-1 detail-btn" data-idx="${idx}" aria-label="Ø¬Ø²Ø¦ÛŒØ§Øª">Ù…Ø´Ø§Ù‡Ø¯Ù‡</button></td>
    </tr>`;
  }).join('');
}

// Single delegated listener on tbody â€” attached once in DOMContentLoaded
function attachTableDelegation() {
  const tbody = document.getElementById('tableBody');
  tbody.addEventListener('click', e => {
    const btn = e.target.closest('.detail-btn');
    const row = e.target.closest('.province-row');
    if (btn) { e.stopPropagation(); openModalByIdx(Number(btn.dataset.idx)); return; }
    if (row) openModalByIdx(Number(row.dataset.idx));
  });
  tbody.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      const row = e.target.closest('.province-row');
      if (row) openModalByIdx(Number(row.dataset.idx));
    }
  });
}

function openModalByIdx(idx) {
  const p = provinces[idx];
  if (p) openModal(p.name);
}

/* ============================================================
   FILTER & SORT
   ============================================================ */
function applyFilters() {
  const q = document.getElementById('searchProvince').value.trim().toLowerCase();
  const tf = document.getElementById('threatFilter').value;
  const sb = document.getElementById('sortBy').value;
  sortCol = sb;

  let filtered = provinces.filter(p => {
    const matchQ = !q || p.name.includes(q) || p.capital.includes(q);
    const matchT = tf === 'all' || p.threat === tf;
    return matchQ && matchT;
  });

  filtered.sort((a, b) => {
    let va, vb;
    switch(sortCol) {
      case 'threat':   va = THREAT_ORDER[a.threat]; vb = THREAT_ORDER[b.threat]; break;
      case 'sensors':  va = a.sensors; vb = b.sensors; break;
      case 'lastCheck':va = new Date(a.lastCheck).getTime(); vb = new Date(b.lastCheck).getTime(); break;
      default:         va = a.name; vb = b.name;
    }
    return va < vb ? -sortDir : va > vb ? sortDir : 0;
  });

  renderTable(filtered);
  document.getElementById('filterCount').textContent =
    `Ù†Ù…Ø§ÛŒØ´ ${toPersianNum(filtered.length)} Ø§Ø² ${toPersianNum(provinces.length)} Ø§Ø³ØªØ§Ù†`;
  updateStats();

  // update sorted column headers
  document.querySelectorAll('#provincesTable thead th[data-col]').forEach(th => {
    th.classList.toggle('sorted', th.dataset.col === sortCol);
  });
}

function sortTable(col) {
  if (sortCol === col) sortDir *= -1; else { sortCol = col; sortDir = 1; }
  document.getElementById('sortBy').value = col === 'capital' ? 'name' : col;
  applyFilters();
}

function resetFilters() {
  document.getElementById('searchProvince').value = '';
  document.getElementById('threatFilter').value = 'all';
  document.getElementById('sortBy').value = 'name';
  sortDir = 1;
  applyFilters();
}

/* ============================================================
   STATS
   ============================================================ */
function updateStats() {
  const active   = provinces.filter(p => p.threat === 'green').length;
  const warning  = provinces.filter(p => p.threat === 'yellow' || p.threat === 'orange').length;
  const critical = provinces.filter(p => p.threat === 'red').length;
  document.getElementById('statActive').textContent   = toPersianNum(active);
  document.getElementById('statWarning').textContent  = toPersianNum(warning);
  document.getElementById('statCritical').textContent = toPersianNum(critical);
}

/* ============================================================
   MODAL
   ============================================================ */
function openModal(name) {
  const p = provinces.find(x => x.name === name);
  if (!p) return;

  document.getElementById('modalTitle').textContent    = p.name;
  document.getElementById('modalCapital').textContent  = `Ù…Ø±Ú©Ø² Ø§Ø³ØªØ§Ù†: ${p.capital}`;
  document.getElementById('modalSensors').textContent  = toPersianNum(p.sensors);
  document.getElementById('modalAlerts').textContent   = toPersianNum(p.alertCount || 0);
  document.getElementById('modalReports').textContent  = toPersianNum(p.reportCount || 0);

  const lc = new Date(p.lastCheck);
  const minAgo = Math.floor((Date.now() - lc.getTime()) / 60000);
  document.getElementById('modalLastCheck').textContent =
    minAgo < 60 ? `${toPersianNum(minAgo)} Ø¯Ù‚ÛŒÙ‚Ù‡ Ù¾ÛŒØ´` : `${toPersianNum(Math.floor(minAgo/60))} Ø³Ø§Ø¹Øª Ù¾ÛŒØ´`;

  document.getElementById('modalThreatBadge').innerHTML =
    `<span class="badge badge-${p.threat} text-lg">${THREAT_EMOJI[p.threat]} ${THREAT_LABEL[p.threat]}</span>`;

  // cities
  const cities = PROVINCE_CITIES[p.name] || [];
  document.getElementById('modalCities').innerHTML = cities.map(c =>
    `<span class="text-xs bg-cyan-900/20 border border-cyan-700/30 text-cyan-300 px-3 py-1 rounded-full">${sanitizeHTML(c)}</span>`
  ).join('');

  // alerts list
  const alertTemplates = {
    green:  ['ÙˆØ¶Ø¹ÛŒØª Ø¹Ø§Ø¯ÛŒ â€” Ù‡ÛŒÚ† ØªÙ‡Ø¯ÛŒØ¯ÛŒ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù†Ø´Ø¯Ù‡','Ù¾Ø§ÛŒØ´ Ù…Ø³ØªÙ…Ø± Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù… Ø§Ø³Øª','ØªÙ…Ø§Ù… Ø­Ø³Ú¯Ø±Ù‡Ø§ Ø¯Ø± ÙˆØ¶Ø¹ÛŒØª Ø³Ø¨Ø²'],
    yellow: ['Ø§ÙØ²Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒ Ø¯Ø± Ø´Ø§Ø®Øµâ€ŒÙ‡Ø§ÛŒ Ù…Ø­ÛŒØ·ÛŒ','Ù‡Ø´Ø¯Ø§Ø± Ø³Ø·Ø­ Û± ØµØ§Ø¯Ø± Ø´Ø¯','ØªÛŒÙ… ÙˆØ§Ú©Ù†Ø´ Ø³Ø±ÛŒØ¹ Ø¯Ø± Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ¨Ø§Ø´'],
    orange: ['Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù†Ù…ÙˆÙ†Ù‡ Ù…Ø´Ú©ÙˆÚ© Ø¯Ø± Ù…Ù†Ø·Ù‚Ù‡ ØµÙ†Ø¹ØªÛŒ','Ù‡Ø´Ø¯Ø§Ø± Ø³Ø·Ø­ Û² â€” Ø¨Ø§Ø²Ø±Ø³ÛŒ Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…','Ù…Ø­Ø¯ÙˆØ¯ÛŒØª ØªØ±Ø¯Ø¯ Ø¯Ø± Ù…Ù†Ø§Ø·Ù‚ Ø®Ø§Øµ Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯'],
    red:    ['Ø¨Ø­Ø±Ø§Ù† Ø²ÛŒØ³ØªÛŒ ØªØ£ÛŒÛŒØ¯ Ø´Ø¯','Ø³ØªØ§Ø¯ Ø¨Ø­Ø±Ø§Ù† ØªØ´Ú©ÛŒÙ„ Ø´Ø¯Ù‡','Ø¹Ù…Ù„ÛŒØ§Øª Ú©Ù†ØªØ±Ù„ Ø¢Ù„ÙˆØ¯Ú¯ÛŒ Ø¢ØºØ§Ø² Ø´Ø¯Ù‡']
  };
  const alerts = alertTemplates[p.threat];
  document.getElementById('modalAlertsList').innerHTML = alerts.map((a, i) => {
    const col = p.threat === 'green' ? '#00ff88' : p.threat === 'yellow' ? '#ffd700' : p.threat === 'orange' ? '#ff6600' : '#ff003c';
    return `<div class="flex items-start gap-3 p-3 rounded-lg" style="background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07)">
      <span style="color:${col};font-size:.9rem">â—</span>
      <span class="text-sm text-gray-300">${sanitizeHTML(a)}</span>
    </div>`;
  }).join('');

  // mini chart
  setTimeout(() => drawModalChart(p), 50);

  const modal = document.getElementById('provinceModal');
  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
  document.getElementById('modalBox').focus();
}

function closeModal() {
  document.getElementById('provinceModal').classList.remove('active');
  document.body.style.overflow = '';
}

function closeModalOnBackdrop(e) {
  if (e.target === document.getElementById('provinceModal')) closeModal();
}

document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

/* ============================================================
   CHARTS â€” vanilla Canvas API
   ============================================================ */
function drawLineChart() {
  const canvas = document.getElementById('lineChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.offsetWidth || 500;
  const H = 200;
  canvas.width = W; canvas.height = H;
  ctx.clearRect(0, 0, W, H);

  // grid
  ctx.strokeStyle = 'rgba(255,255,255,.06)';
  ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = H * 0.1 + (H * 0.8) * (i / 4);
    ctx.beginPath(); ctx.moveTo(40, y); ctx.lineTo(W - 16, y); ctx.stroke();
  }

  // 24h data points (simulate threat index 0-100)
  const hours = 25;
  const data = Array.from({length: hours}, (_, i) => {
    const base = 20 + 10 * Math.sin(i * 0.4) + 8 * Math.cos(i * 0.7);
    return Math.max(5, Math.min(90, base + (Math.random() * 10 - 5)));
  });

  const xStep = (W - 56) / (hours - 1);
  const yScale = (H * 0.8) / 100;

  // gradient fill
  const grad = ctx.createLinearGradient(0, 0, 0, H);
  grad.addColorStop(0, 'rgba(0,240,255,.35)');
  grad.addColorStop(1, 'rgba(0,240,255,.02)');
  ctx.beginPath();
  ctx.moveTo(40, H * 0.9);
  data.forEach((v, i) => ctx.lineTo(40 + i * xStep, H * 0.9 - v * yScale));
  ctx.lineTo(40 + (hours-1) * xStep, H * 0.9);
  ctx.closePath();
  ctx.fillStyle = grad;
  ctx.fill();

  // line
  ctx.beginPath();
  ctx.strokeStyle = '#00f0ff';
  ctx.lineWidth = 2.5;
  ctx.lineJoin = 'round';
  data.forEach((v, i) => {
    const x = 40 + i * xStep;
    const y = H * 0.9 - v * yScale;
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.stroke();

  // dots at hours 0, 6, 12, 18, 24
  [0, 6, 12, 18, 24].forEach(h => {
    if (h >= hours) return;
    const x = 40 + h * xStep;
    const y = H * 0.9 - data[h] * yScale;
    ctx.beginPath();
    ctx.arc(x, y, 4, 0, Math.PI * 2);
    ctx.fillStyle = '#00f0ff';
    ctx.fill();
    ctx.fillStyle = 'rgba(0,240,255,.7)';
    ctx.font = '10px Vazirmatn,sans-serif';
    ctx.fillText(`${h}h`, x - 8, H - 4);
  });

  // y-axis label
  ctx.fillStyle = 'rgba(0,240,255,.5)';
  ctx.font = '10px Vazirmatn,sans-serif';
  ctx.fillText('Û±Û°Û°', 0, H * 0.1 + 4);
  ctx.fillText('Û°', 8, H * 0.9 + 4);
}

function drawBarChart() {
  const canvas = document.getElementById('barChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.offsetWidth || 500;
  const H = 200;
  canvas.width = W; canvas.height = H;
  ctx.clearRect(0, 0, W, H);

  const top10 = [...provinces]
    .sort((a, b) => b.reportCount - a.reportCount)
    .slice(0, 10);

  const maxVal = Math.max(...top10.map(p => p.reportCount), 1);
  const barW = Math.floor((W - 60) / top10.length) - 6;
  const chartH = H * 0.75;

  // grid lines
  ctx.strokeStyle = 'rgba(255,255,255,.06)';
  ctx.lineWidth = 1;
  for (let i = 1; i <= 4; i++) {
    const y = H * 0.1 + chartH * (1 - i / 4);
    ctx.beginPath(); ctx.moveTo(40, y); ctx.lineTo(W - 10, y); ctx.stroke();
  }

  top10.forEach((p, i) => {
    const barH = (p.reportCount / maxVal) * chartH;
    const x = 40 + i * (barW + 6);
    const y = H * 0.1 + chartH - barH;

    const grad = ctx.createLinearGradient(0, y, 0, y + barH);
    grad.addColorStop(0, '#00ff88');
    grad.addColorStop(1, 'rgba(0,255,136,.2)');
    ctx.fillStyle = grad;
    ctx.beginPath();
    ctx.roundRect ? ctx.roundRect(x, y, barW, barH, [4,4,0,0]) : ctx.rect(x, y, barW, barH);
    ctx.fill();

    // value label
    ctx.fillStyle = '#00ff88';
    ctx.font = 'bold 10px Vazirmatn,sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(toPersianNum(p.reportCount), x + barW / 2, y - 4);

    // name label
    ctx.fillStyle = 'rgba(200,200,200,.7)';
    ctx.font = '9px Vazirmatn,sans-serif';
    const shortName = p.name.length > 5 ? p.name.substring(0, 5) + 'â€¦' : p.name;
    ctx.fillText(shortName, x + barW / 2, H - 4);
    ctx.textAlign = 'start';
  });
}

function drawModalChart(p) {
  const canvas = document.getElementById('modalChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.offsetWidth || 680;
  const H = 120;
  canvas.width = W; canvas.height = H;
  ctx.clearRect(0, 0, W, H);

  const threatBase = {green: 15, yellow: 35, orange: 60, red: 85};
  const base = threatBase[p.threat];
  const pts = 25;
  const data = Array.from({length: pts}, (_, i) =>
    Math.max(5, Math.min(95, base + 12 * Math.sin(i * 0.5) + (Math.random() * 14 - 7)))
  );

  const xStep = (W - 20) / (pts - 1);
  const yScale = (H * 0.8) / 100;
  const colors = {green:'#00ff88', yellow:'#ffd700', orange:'#ff6600', red:'#ff003c'};
  const col = colors[p.threat];

  ctx.beginPath();
  ctx.moveTo(10, H * 0.9);
  data.forEach((v, i) => ctx.lineTo(10 + i * xStep, H * 0.9 - v * yScale));
  ctx.lineTo(10 + (pts-1) * xStep, H * 0.9);
  ctx.closePath();
  ctx.fillStyle = `${col}22`;
  ctx.fill();

  ctx.beginPath();
  ctx.strokeStyle = col;
  ctx.lineWidth = 2;
  ctx.lineJoin = 'round';
  data.forEach((v, i) => {
    const x = 10 + i * xStep;
    const y = H * 0.9 - v * yScale;
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.stroke();
}

/* ============================================================
   DATE / TIME
   ============================================================ */
function updateDateTime() {
  const str = jalaliNow();
  const el = document.getElementById('currentDateTime');
  const elM = document.getElementById('currentDateTimeMobile');
  if (el) el.textContent = str;
  if (elM) elM.textContent = str;
}

/* ============================================================
   AUTO REFRESH (every 30s)
   ============================================================ */
function autoRefresh() {
  // bump last check times slightly for realism
  provinces.forEach(p => {
    p.lastCheck = new Date(new Date(p.lastCheck).getTime() + 30000);
  });
  applyFilters();
  drawLineChart();
  drawBarChart();
}

/* ============================================================
   MOBILE MENU
   ============================================================ */
function toggleMobileMenu() {
  const nav = document.getElementById('mobileNav');
  const btn = document.getElementById('hamburgerBtn');
  const isOpen = !nav.classList.contains('hidden');
  nav.classList.toggle('hidden');
  nav.classList.toggle('flex');
  btn.setAttribute('aria-expanded', String(!isOpen));
}

/* ============================================================
   INIT
   ============================================================ */
document.addEventListener('DOMContentLoaded', () => {
  loadProvinces();
  enrichProvinces();
  attachTableDelegation();
  applyFilters();
  updateStats();
  updateDateTime();

  // draw charts after layout
  requestAnimationFrame(() => {
    drawLineChart();
    drawBarChart();
  });

  // clock tick
  setInterval(updateDateTime, 1000);

  // auto refresh every 30s
  setInterval(autoRefresh, 30000);

  // redraw charts on resize
  window.addEventListener('resize', () => {
    drawLineChart();
    drawBarChart();
  });
});
</script>
</body>
</html>
